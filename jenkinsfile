pipeline {
    agent { 
        label 'vm-agent'
    }
    
    stages {
        stage('Test Nexus Connection') {
            steps {
                sh '''
                    echo "Attempting to connect to Nexus repository..."
                    curl -v -u admin:admin http://192.168.33.215:8083/service/rest/v1/status
                '''
            }
        }
        
        stage('List Nexus Repositories') {
            steps {
                sh '''
                    curl -s -u admin:admin http://192.168.33.215:8083/service/rest/v1/repositories | grep -o '"name":"[^"]*"' | sort
                '''
            }
        }
        
        stage('Clone and List GitHub Repository') {
            steps {
                sh '''
                    rm -rf FullStack || true
                    git clone http://github.com/otyr-weaver/FullStack.git
                    cd FullStack
                    ls -la
                    
                '''
            }
        }
        
        stage('Test Docker Push to Nexus') {
            steps {
                sh '''
                
                    docker login -u admin -p admin http://192.168.33.215:5000
                    
                    docker pull otyr/fullstack-frontend
                    docker pull otyr/fullstack-backend
                    
                    docker tag otyr/fullstack-frontend 192.168.33.215:5000/front/frontend:latest
                    docker tag otyr/fullstack-backend 192.168.33.215:5000/back/backend:latest
                    
                    docker push 192.168.33.215:5000/front/frontend:latest
                    docker push 192.168.33.215:5000/back/backend:latest
                    
                    echo "Cleaning up local containers..."
                    docker ps -q --filter ancestor=hello-world | xargs -r docker stop | xargs -r docker rm

                    echo "Cleaning up local images..."
                    docker rmi 192.168.33.215:5000/test/hello-world:latest || true
                    docker rmi hello-world || true
                '''
            }
        }
    }
    
    post {
        always {
            echo "===== CONNECTION TEST COMPLETE ====="
        }
    }
}
